<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户列表</title>
    {% load static %} <!-- 加载 Django 的 static 标签库 -->
    <link rel="stylesheet" href="{% static 'css/x_list_table.css' %}"> <!-- 引入 CSS 文件 -->
    <script>
        function checkNewComments() {
            fetch("{% url 'check_new_comments' %}")  // 访问 Django API
                .then(response => response.json())
                .then(data => {
                    let alertBox = document.getElementById("alert-box");
    
                    // 如果没有异常评论，清除提示框
                    if (data.new_comments.length === 0) {
                        if (alertBox) {
                            alertBox.remove();
                        }
                        return;  // 终止函数
                    }
    
                    // 如果提示框不存在，则创建
                    if (!alertBox) {
                        alertBox = document.createElement("div");
                        alertBox.id = "alert-box";
                        alertBox.style.position = "fixed";
                        alertBox.style.top = "10px";
                        alertBox.style.right = "10px";
                        alertBox.style.background = "#ffeb3b";
                        alertBox.style.padding = "15px";
                        alertBox.style.border = "2px solid #ff9800";
                        alertBox.style.borderRadius = "5px";
                        alertBox.style.cursor = "pointer";
                        alertBox.style.zIndex = "1000";
                        alertBox.style.maxWidth = "300px";
                        alertBox.style.boxShadow = "2px 2px 10px rgba(0,0,0,0.2)";
                        document.body.appendChild(alertBox);
                    }
    
                    // 更新提示框内容
                    let html = `<strong>注意：</strong> 有 ${data.new_comments.length} 个客户最新评论不是归属人！<br><ul>`;
    
                    data.new_comments.forEach(customer => {
                        html += `<li><a href="#" data-customer-id="${customer.id}">${customer.name} (${customer.phone})</a></li>`;
                    });
    
                    html += `</ul><p style="margin-top:5px;font-size:12px;color:red;">点击客户姓名跳转</p>`;
    
                    alertBox.innerHTML = html;
    
                    // 监听点击事件
                    alertBox.addEventListener("click", function (event) {
                        if (event.target.tagName === "A") {
                            let customerId = event.target.getAttribute("data-customer-id");
                            let targetRow = document.getElementById("customer-" + customerId);
                            
                            if (targetRow) {
                                targetRow.scrollIntoView({ behavior: "smooth", block: "center" });
                                targetRow.classList.add("highlighted-row");
                                setTimeout(() => targetRow.classList.remove("highlighted-row"), 2000);
                            } else {
                                alert("该客户数据尚未加载，请检查筛选条件");
                            }
                        }
                    });
                });
        }
    
        // **每 5 秒检查一次新评论**
        setInterval(checkNewComments, 5000);
    </script>
</head>
<body>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>电话</th>
                    <th>归属人</th>
                    <th>创建时间</th>
                    <th>数据源</th>
                    <th>期数</th>
                    <th>微信名</th>
                    <th>城市</th>
                    <th>接通</th>
                    <th>感兴趣</th>
                    <th>加微信</th>
                    <th>入群</th>
                    <th class="description-column" style="width: 150px;">情况描述</th>
                    <th>客户等级</th>
                    <th>评论</th>
                    <th>考虑</th>
                    <th>家人商量</th>
                    <th>成交</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr id="customer-{{ customer.id }}"
                {% if customer.comments.exists and customer.comments.last.created_by.username != customer.created_by.username %}
                    class="highlighted-row"
                {% endif %}
            >
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.phone }}</td>
                        <td>{{ customer.created_by }}</td>
                        <td>{{ customer.created_at|date:"Y-m-d" }}</td>
                        <td>{{ customer.data_source }}</td>
                        <td>{{ customer.student_batch }}</td>
                        <td>{{ customer.wechat_name }}</td>
                        <td>{{ customer.city }}</td>
                        <td>{% if customer.is_contacted %}✔️{% else %}✘{% endif %}</td>
                        <td>{% if customer.is_invited %}✔️{% else %}✘{% endif %}</td>
                        <td>{% if customer.is_wechat_added %}✔️{% else %}✘{% endif %}</td>
                        <td>{% if customer.is_joined %}✔️{% else %}✘{% endif %}</td>
                        <td class="description-column">
                            {% if customer.description_history_list.exists %}
                                <ul>
                                    {% for history in customer.description_history_list %}
                                        <li>
                                            <p>{{ history.new_description }}</p>
                                            <small>
                                                <strong>更新时间:</strong> {{ history.modified_at|date:"Y-m-d H:i" }}<br>
                                                <strong>更新人:</strong> {{ history.modified_by.username }}
                                            </small>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                无描述历史
                            {% endif %}
                        </td>
                        <td>{{ customer.customer_level }}</td>
                        <td class="comments-column">
                            {% if customer.comments.exists %}
                                {% for comment in customer.comments.all %}
                                    <p>
                                        <strong>{{ comment.created_by.username }}:</strong>
                                        {{ comment.content }}
                                    </p>
                                {% endfor %}
                            {% else %}
                                无评论
                            {% endif %}
                        </td>
                        <td>{% if customer.reconsider_checked %}✔️{% else %}✘{% endif %}</td>
                        <td>{% if customer.discuss_checked %}✔️{% else %}✘{% endif %}</td>
                        <td>{% if customer.is_closed %}✔️{% else %}✘{% endif %}</td>
                        <td>
                            <a href="{% url 'edit_customer' customer.id %}">更新</a>
                            <button class="delete-btn" data-id="{{ customer.id }}" onclick="deleteCustomer(this)">删除</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>